sp_configure 'show advanced options', 1;
RECONFIGURE;
GO
sp_configure 'Ad Hoc Distributed Queries', 1;
RECONFIGURE;
GO

use ccrep;
go

SELECT [FILIAL],CAST([POSTDATE] as date) as [POSTDATE],[CODE_VO],[TYPE_TOOLING],CAST([OPER_TYPE] as tinyint) as [OPER_TYPE],[DIRECTION_PAY],[COUNT],
cast([SHARE] as decimal) as [SHARE],[CCY],cast([AMOUNT_ALL] as decimal) as [AMOUNT_ALL],cast([AMNT_INCOME] as decimal) as [AMNT_INCOME],
[BIC_PARTNER],[COUNTRY_REZ],[SWIFT_405],[SWIFT_FIL_405],
[NAME_REZ],[TYPE_REZ], cast([INN] as varchar(12)) as [INN],[NAME_NEREZ],[TYPE_NEREZ],[COUNTRY_NEREZ],[ISSUER_NAME],[SECURITY_CODE],
[REG_NUM_ISSUER],CAST([DATE_REG_ISSUER] as date) as [DATE_REG_ISSUER],convert(date,[REPAY_DATE],104) as [REPAY_DATE],[CCY_ISSUER],
[ISSUER_CODE],[ISSUER_REESTR],[NOTICE],
[NOTICE_ISSUER],[NOTICE_EXCHANGE],[NOTICE_INST],[NOTICE_PROPERTY],[NOTICE_BANK],[BANK_NAME],
[COUNTRY_BANK],[PARTNER_NAME],[COUNTRY_PARTNER], convert(date,[VALUEDATE],104) as [VALUEDATE], [REF_NUM],[CCD_USER],[NARRATIVE],
[CITY_CODE],[NOTICE_REPORT],[DEP_ACC],[CONTRACT_NUM],[FORM],[SECTION],[STATUS], cast([ID_REP] as int) as [ID_REP] ,[AUTOR],
[SOURCE],[SUPDOC_FL],[SOURCE_NAME]
INTO VK_ARCHIVE_TMP
FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0','Excel 12.0; Database=c:\temp\ArchiveAccessForLoad.xlsx', [DataAccess$]);

GO

INSERT INTO VK_ARCHIVE_TMP SELECT [FILIAL],convert(date, [POSTDATE], 104) as [POSTDATE],[CODE_VO],[TYPE_TOOLING],
CAST([OPER_TYPE] as tinyint),[DIRECTION_PAY],[COUNT],
cast([SHARE] as decimal) as [SHARE],[CCY],cast([AMOUNT_ALL] as decimal) as [AMOUNT_ALL],cast([AMNT_INCOME] as decimal) as [AMNT_INCOME],
[BIC_PARTNER],[COUNTRY_REZ],[SWIFT_405],[SWIFT_FIL_405],
[NAME_REZ],[TYPE_REZ],cast([INN] as varchar(12)) as [INN],[NAME_NEREZ],[TYPE_NEREZ],[COUNTRY_NEREZ],[ISSUER_NAME],[SECURITY_CODE],
[REG_NUM_ISSUER],convert(date, [DATE_REG_ISSUER],104) as [DATE_REG_ISSUER],convert(date,[REPAY_DATE],104) as [REPAY_DATE],
[CCY_ISSUER],[ISSUER_CODE],[ISSUER_REESTR],[NOTICE],
[NOTICE_ISSUER],[NOTICE_EXCHANGE],[NOTICE_INST],[NOTICE_PROPERTY],[NOTICE_BANK],[BANK_NAME],
[COUNTRY_BANK],[PARTNER_NAME],[COUNTRY_PARTNER], convert(date, [VALUEDATE], 104) as [VALUEDATE],[REF_NUM],[CCD_USER],[NARRATIVE],
[CITY_CODE],[NOTICE_REPORT],[DEP_ACC],[CONTRACT_NUM],[FORM],[SECTION],[STATUS],cast([ID_REP] as int) as [ID_REP],[AUTOR],
[SOURCE],[SUPDOC_FL],[SOURCE_NAME]
FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0', 'Excel 12.0; Database=c:\temp\Archive_405_ForLoad.xlsx', [раздел_1$]);

GO

INSERT INTO VK_ARCHIVE_TMP SELECT [FILIAL],convert(date, [POSTDATE], 104) as [POSTDATE],[CODE_VO],[TYPE_TOOLING],
CAST([OPER_TYPE] as tinyint),[DIRECTION_PAY],[COUNT],
cast([SHARE] as decimal) as [SHARE],[CCY],cast([AMOUNT_ALL] as decimal) as [AMOUNT_ALL],cast([AMNT_INCOME] as decimal) as [AMNT_INCOME],
[BIC_PARTNER],[COUNTRY_REZ],[SWIFT_405],[SWIFT_FIL_405],
[NAME_REZ],[TYPE_REZ],cast([INN] as varchar(12)) as [INN],[NAME_NEREZ],[TYPE_NEREZ],[COUNTRY_NEREZ],[ISSUER_NAME],[SECURITY_CODE],
[REG_NUM_ISSUER],convert(date, [DATE_REG_ISSUER],104) as [DATE_REG_ISSUER],convert(date,[REPAY_DATE],104) as [REPAY_DATE],
[CCY_ISSUER],[ISSUER_CODE],[ISSUER_REESTR],[NOTICE],
[NOTICE_ISSUER],[NOTICE_EXCHANGE],[NOTICE_INST],[NOTICE_PROPERTY],[NOTICE_BANK],[BANK_NAME],
[COUNTRY_BANK],[PARTNER_NAME],[COUNTRY_PARTNER], convert(date, [VALUEDATE], 104) as [VALUEDATE],[REF_NUM],[CCD_USER],[NARRATIVE],
[CITY_CODE],[NOTICE_REPORT],[DEP_ACC],[CONTRACT_NUM],[FORM],[SECTION],[STATUS],cast([ID_REP] as int) as [ID_REP],[AUTOR],
[SOURCE],[SUPDOC_FL],[SOURCE_NAME]
FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0', 'Excel 12.0; Database=c:\temp\Archive_405_ForLoad.xlsx', [раздел_2$]);

GO

-- Fill VK_ADDINF_REP
INSERT INTO [dbo].[VK_ADDINF_REP] 
			    ([FORM], [SECTION], [STATUS], ID_REP, [AUTHOR], [SOURCE], SUPDOC_FL, [SOURCE_NAME],   
				 [IRB_PAYMENT_RK], [PAYMENT_RK])
SELECT [FORM], [SECTION],[STATUS], ID_REP, AUTOR, [SOURCE], SUPDOC_FL, [SOURCE_NAME],   
	(row_number() OVER(ORDER BY (SELECT NULL))) as IRB_PAYMENT_RK, (row_number() OVER(ORDER BY (SELECT NULL))) as PAYMENT_RK
FROM [dbo].[VK_ARCHIVE_TMP]

DECLARE @COUNT_ARCHIVE bigint
DECLARE @FIRST_ID bigint
DECLARE @LAST_ID bigint

select @COUNT_ARCHIVE = Count(*) from VK_ARCHIVE_TMP
			select @LAST_ID = @@IDENTITY 
			SET @FIRST_ID = @LAST_ID - @COUNT_ARCHIVE
-- select @LAST_ID as LAST_ID, @FIRST_ID as FIRST_ID

-- Fill VK_BASIC_REP
INSERT INTO dbo.VK_BASIC_REP 
	([FILIAL],[POSTDATE],[CODE_VO],[TYPE_TOOLING],[OPER_TYPE],[DIRECTION_PAY],[COUNT],
		  [SHARE],[CCY], [AMOUNT_ALL],[AMNT_INCOME],[SWIFT],[SWIFT_FIL], [VALUEDATE],
		  [REF_NUM], ID_OPER)
SELECT RIGHT('000' + [FILIAL], 4),[POSTDATE],[CODE_VO],[TYPE_TOOLING],[OPER_TYPE],[DIRECTION_PAY],[COUNT],
		[SHARE],[CCY], [AMOUNT_ALL],[AMNT_INCOME],[SWIFT_405],[SWIFT_FIL_405], [VALUEDATE],
		[REF_NUM], (@FIRST_ID + (row_number() OVER(ORDER BY (SELECT NULL)))) as ID
	FROM [dbo].[VK_ARCHIVE_TMP] 

-- Fill VK_CLIENT_REP
INSERT INTO dbo.VK_CLIENT_REP 
	([BIC_PARTNER],[COUNTRY_REZ],[NAME_REZ],[TYPE_REZ],[INN],
		[NAME_NEREZ],[TYPE_NEREZ],[COUNTRY_NEREZ],[BANK_NAME],
		[COUNTRY_BANK],[PARTNER_NAME],[COUNTRY_PARTNER],
		[ID_OPER])
SELECT [BIC_PARTNER], [COUNTRY_REZ], [NAME_REZ],[TYPE_REZ],[INN],
	[NAME_NEREZ],[TYPE_NEREZ],[COUNTRY_NEREZ],[BANK_NAME],
	[COUNTRY_BANK],[PARTNER_NAME],[COUNTRY_PARTNER],
	(@FIRST_ID + (row_number() OVER(ORDER BY (SELECT NULL)))) as ID
FROM [dbo].[VK_ARCHIVE_TMP]

-- Fill VK_ISSUER_REP
INSERT INTO [dbo].[VK_ISSUER_REP]
	([ISSUER_NAME],[SECURITY_CODE],[REG_NUM_ISSUER],[DATE_REG_ISSUER],[REPAY_DATE],[CCY_ISSUER],
		[ISSUER_CODE],[ISSUER_REESTR], ID_OPER)
SELECT [ISSUER_NAME],[SECURITY_CODE],[REG_NUM_ISSUER],[DATE_REG_ISSUER],[REPAY_DATE],[CCY_ISSUER],
	[ISSUER_CODE],[ISSUER_REESTR],
LAST_ID = @FIRST_ID + (row_number() OVER(ORDER BY (SELECT NULL)))
FROM [dbo].[VK_ARCHIVE_TMP]

-- Fill VK_NOTICE_REP
INSERT INTO dbo.VK_NOTICE_REP 
	([NOTICE],[NOTICE_ISSUER],[NOTICE_EXCHANGE],[NOTICE_INST],[NOTICE_PROPERTY],[NOTICE_BANK], ID_OPER)
SELECT [NOTICE],[NOTICE_ISSUER],[NOTICE_EXCHANGE],[NOTICE_INST],[NOTICE_PROPERTY],[NOTICE_BANK],
	LAST_ID = @FIRST_ID + (row_number() OVER(ORDER BY (SELECT NULL)))
	FROM [dbo].[VK_ARCHIVE_TMP]

-- Fill VK_ADD_REP
INSERT INTO [dbo].[VK_ADD_REP] ([CCD_USER],[NARRATIVE],[CITY_CODE],
			[NOTICE_REPORT],[DEP_ACC],[CONTRACT_NUM], ID_OPER)
SELECT [CCD_USER],[NARRATIVE],[CITY_CODE], [NOTICE_REPORT],[DEP_ACC],[CONTRACT_NUM],
LAST_ID = @FIRST_ID + (row_number() OVER(ORDER BY (SELECT NULL)))
FROM [dbo].[VK_ARCHIVE_TMP]

GO

DROP TABLE [dbo].[VK_ARCHIVE_TMP]

GO